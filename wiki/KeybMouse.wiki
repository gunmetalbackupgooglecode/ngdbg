#summary Работа с мышью и клавиатурой

= Встроенный драйвер 8042 PS/2 порта =

Отладчик имеет собственный минидрайвер PS/2 контроллера 8042. Он организует базовый ввод-вывод, обеспечивая доступ к подключенным к контроллеру устройствам - клавиатуре и мыши PS/2 (с другими типами клавиатур и мышей отладчик пока не работает).
Для реакции на нажатия клавиатуры отладчик устанавливает ISR-callback через IOCTL_INTERNAL_I8042_HOOK_KEYBOARD.

Когда активен отладчик, прерывания могут быть запрещены. Поэтому, для чтения скан-кодов контроллер работает в режиме опроса (polled mode) и для этого есть функции I8xGetBytePolled, I8xPutBytePolled.
Так же внутренний драйвер 8042.sys позволяет задать mouse callback, который будет вызываться всякий раз, когда I8xGetBytePolled будет обнаруживать байт от контроллера, который пришел из дополнительного устройства (auxiliary device, обычно это мышь) в то время, как ожидается байт от клавиатуры.

= Клавиатура =

Для работы с клавиатурой имеется два набора скан-кодов основных алфавитноцифровых клавиш (нижнего и верхнего регистра) и функция KeybdScanCodeToAsciiCode.
Пока отладчик не активен, ISR callback отслеживает нажатия NumLock, ScrollLock, CapsLock, чтобы сохранить их значения перед входом в отладчик (нельзя опрашивать стандартный драйвер на момент входа в отладчик - он может быть под отладкой, что вызовет рекурсию).
На время работы отладчика значения индикаторов перезагружаются на внутренние для отладчика, а при выходе восстанавливаются обратно.

= Мышь =

Когда I8xGetBytePolled обнаруживает байты от дополнительного устройства, вызывается каллбек для их обработки. Управление передается в ProcessMouseInput из mouse.cpp
Она собирает байты и, когда соберет полный пакет, вызывает ReportMouseStateChange, чтобы зафиксировать изменения состояния мыши. Та создает пакет изменений MOUSE_STATE_CHANGE_PACKET и отсылает его интерфейсной части отладчика в worker.cpp в функцию StateChangeCallbackRoutine. Она перерисовывает курсор и выполняет другие действия, которые необходимы при изменении состояния мыши.